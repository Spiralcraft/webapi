<t:Eval
  xmlns:t="class:/spiralcraft/task/"
  xmlns:dt="class:/spiralcraft/data/task/"
  xmlns:j="class:/java/lang/"
  xmlns:sa="class:/spiralcraft/servlet/auth/"
  xmlns:sec="class:/spiralcraft/security/auth/"
  xmlns:wapi="class:/spiralcraft/webapi/"
  xmlns:api="context://code/api/"
  >
  <contextX>
    [#p] { userId:[@j:String]
    }
  </contextX>
  <x>
    {
      authResult
        :=[p].userId!=null
          ?@{ 
              [sa:Filter].applyCredentials([wapi:Session].subscriptionId,[p].userId)
              ,[sec:AuthSession].authenticate()
              ,[sec:AuthSession].authenticated
            }
          :false
      ,regResult
        :=[p].userId
          { .!=null &amp;&amp; !..authResult
              ?[.]
                { [*api:Register].(.)
                , [sa:Filter].clearSession()
                , [sec:AuthSession].clearCredentials()
                , [sa:Filter].applyCredentials([wapi:Session].subscriptionId,.)
                , [sec:AuthSession].authenticate()
                , [sec:AuthSession].authenticated
                }
              :false
          }
    }
    { [sec:AuthSession].authenticated
    }
  </x>

</t:Eval>